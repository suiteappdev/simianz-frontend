// Start timing server startup time asap.
'use strict';

global.liveStartTime = new Date();
console.log('Starting app...');

//region Imports
var _ = require('lodash');
var config = require('configurize');
//endregion

module.exports = function () {
  var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

  // TODO(vjpr): Use opts instead of config to set defaults.

  // NODE_PATH
  //////////////////////////////////////////////////////////////////////////////

  if (!__CLIENT__) {
    (function () {
      var addPath = require('app-module-path').addPath;
      config.live.moduleDirectories.map(function (dir) {
        addPath(dir);
      });
    })();
  }

  // Module aliases
  //////////////////////////////////////////////////////////////////////////////

  // Globals
  //////////////////////////////////////////////////////////////////////////////

  _(config.live.globals).each(function (v, k) {
    global[k] = v;
  }).run();

  // TODO

  // Skip style requires when server side.
  //////////////////////////////////////////////////////////////////////////////

  // TODO(vjpr): Use style collector and serve css.
  if (!__CLIENT__) require.extensions['.less'] = function () {
    return null;
  };
  if (!__CLIENT__) require.extensions['.css'] = function () {
    return null;
  };

  // Unhandled promises
  //////////////////////////////////////////////////////////////////////////////

  // Capture unhandler promise rejections.
  // NOTE: Requires io.js or core-js.
  process.on('unhandledRejection', function (e, promise) {
    console.log(e.stack);
  });
  // TODO: Fire rejection events in the browser.
  // See: https://github.com/petkaantonov/bluebird/blob/master/API.md#global-rejection-events

  // Babel
  //////////////////////////////////////////////////////////////////////////////

  // Save cached roadrunner after server starts and *most* of the dependencies
  // have been loaded.
  //require('./babel').saveRequireResolveCache()
  if (!__CLIENT__) require('./babel')(config.live);
};
//# sourceMappingURL=index.js.map
