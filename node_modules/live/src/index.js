//region Imports
import setupLogging from './logging'
import {Live} from './live'
import locator from './locator'
import _ from 'lodash'
//endregion

// Singleton app instance.
const live = new Live

// Setup basic logging.
setupLogging(live.container)

// opts.fn - an easy way to add hooks without creating a module.
function main(opts) {

  _.defaults(opts, {
    beforeStart: (live) => {},
  })

  // Locate and register plugins.

  if (!__CLIENT__) {
    locator().map(file => {
      const module = require(file)
      live.register(module, file)
    })
  } else {
    Object.keys(window.livePlugins).map(file => {
      const module = window.livePlugins[file]
      live.register(module, file)
    })
  }

  opts.beforeStart(live)

  // Start app.

  live.start().then(() => {
    // App has now started.
  })

  return live

}

// Singleton app instance.
// E.g. When using `import {live} from 'live-app'` syntax to access the app.
main.live = live

main.Live = Live
main.Locator = locator.Locator

module.exports = main
